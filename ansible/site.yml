---
# =============================================================================
# Ubuntu AI Server - Main Playbook
# =============================================================================
# Deploy all components to transform Ubuntu into AI/DevOps powerhouse
#
# Usage:
#   ansible-playbook site.yml                    # Full deployment
#   ansible-playbook site.yml --tags "base,zfs" # Selective deployment
#   ansible-playbook site.yml --skip-tags "security"
# =============================================================================

- name: Ubuntu AI Server - Full Deployment
  hosts: ai_servers
  gather_facts: true

  pre_tasks:
    - name: Display server information
      ansible.builtin.debug:
        msg: |
          ===============================================
          Deploying to: {{ ansible_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          CPU: {{ ansible_processor[2] }} ({{ ansible_processor_vcpus }} vCPUs)
          RAM: {{ (ansible_memtotal_mb / 1024) | round(1) }} GB
          ===============================================
      tags: always

    - name: Ensure we're running on Ubuntu 24.04
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_major_version == "24"
        fail_msg: "This playbook requires Ubuntu 24.04 LTS"
      tags: always

  roles:
    # Phase 1: Base System
    - role: base-system
      tags: [base, phase1]

    # Phase 2: Storage
    - role: zfs-storage
      tags: [zfs, storage, phase2]

    # Phase 3: GPU
    - role: nvidia-cuda
      tags: [nvidia, gpu, cuda, phase3]

    # Phase 4: Container Runtime
    - role: docker-setup
      tags: [docker, containers, phase4]

    # Phase 5: AI Stack
    - role: ai-stack
      tags: [ai-stack, ai, ollama, phase5]

    # Phase 6: DevOps Tools
    - role: devops-tools
      tags: [devops, devops-tools, phase6]

    # Phase 7: Monitoring
    - role: monitoring
      tags: [monitoring, prometheus, grafana, phase7]

    # Phase 8: Backup
    - role: backup
      tags: [backup, phase8]

    # Phase 9: Security (can run independently)
    - role: security
      tags: [security, hardening, phase9]

    # Phase 10: MCP Servers (AI Autonomy)
    - role: mcp-servers
      tags: [mcp, mcp-servers, ai-autonomy, phase10]

    # Phase 11: RAG Stack (Personal RAG Assistant)
    - role: rag-stack
      tags: [rag, rag-stack, vector-db, phase11]

    # Phase 12: n8n Workflow Automation
    - role: n8n
      tags: [n8n, automation, workflows, phase12]

    # Phase 13: Documentation Generator (RAG â†’ Docs)
    - role: docs-generator
      tags: [docs, docs-generator, mkdocs, phase13]

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          ===============================================
          DEPLOYMENT COMPLETE!
          ===============================================

          Services available at:
          - Portainer:  https://{{ server_ip }}:9443
          - Open WebUI: http://{{ server_ip }}:3000
          - Gitea:      http://{{ server_ip }}:3001
          - Grafana:    http://{{ server_ip }}:3002
          - Ollama API: http://{{ server_ip }}:11434
          - Prometheus: http://{{ server_ip }}:9090
          - Traefik:    http://{{ server_ip }}:8080
          - MCP Gateway: http://{{ server_ip }}:{{ mcp.gateway_port }}
          - Neo4j (MCP): http://{{ server_ip }}:7474

          RAG Stack:
          - Qdrant:       http://{{ server_ip }}:{{ rag_stack.qdrant.port }}
          - Docling API:  http://{{ server_ip }}:{{ rag_stack.docling.port }}
          - Interpreter:  http://{{ server_ip }}:{{ rag_stack.interpreter.port }}
          - Ingestion:    http://{{ server_ip }}:{{ rag_stack.ingestion.port }}

          Automation:
          - n8n:          http://{{ server_ip }}:{{ n8n.port }}

          Documentation:
          - Docs Site:    http://{{ server_ip }}:{{ docs_generator.port | default(8088) }}
          - Docs API:     http://{{ server_ip }}:8089

          GPU Status:
            nvidia-smi

          ZFS Pools:
            zpool status

          ===============================================
      tags: always
