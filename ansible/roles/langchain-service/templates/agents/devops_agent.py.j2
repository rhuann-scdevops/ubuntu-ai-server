"""
DevOps Agent
Autonomous agent for infrastructure management and automation tasks.
"""
from typing import Optional, List, Dict, Any
from langchain_ollama import ChatOllama
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain.agents import AgentExecutor, create_tool_calling_agent
from langchain_core.messages import HumanMessage, AIMessage

from config import get_settings, MODEL_CONFIGS
from tools import (
    DockerStatusTool,
    ServiceStatusTool,
    FileReadTool,
    ShellCommandTool,
    KnowledgeSearchTool,
)


DEVOPS_SYSTEM_PROMPT = """You are an expert DevOps engineer assistant with access to various tools for infrastructure management.

Your capabilities include:
- Checking Docker container status and health
- Monitoring systemd services
- Reading configuration files and logs
- Executing safe shell commands for system info
- Searching the knowledge base for documentation

Guidelines:
1. Always verify before taking action - check current state first
2. Use the appropriate tool for each task
3. Provide clear explanations of what you find
4. Suggest next steps when troubleshooting
5. Be cautious with any commands that could affect system state
6. Reference documentation from the knowledge base when relevant

Remember: Safety first. Only use read-only operations unless explicitly asked to make changes."""


class DevOpsAgent:
    """DevOps Agent for infrastructure management."""

    def __init__(
        self,
        model_name: Optional[str] = None,
        temperature: float = 0.2,
        verbose: bool = False
    ):
        self.settings = get_settings()
        self.model_name = model_name or self.settings.default_chat_model
        self.temperature = temperature
        self.verbose = verbose

        self.llm = ChatOllama(
            base_url=self.settings.ollama_url,
            model=self.model_name,
            temperature=self.temperature
        )

        self.tools = [
            DockerStatusTool(),
            ServiceStatusTool(),
            FileReadTool(),
            ShellCommandTool(),
            KnowledgeSearchTool(),
        ]

        self.agent = self._build_agent()
        self.executor = AgentExecutor(
            agent=self.agent,
            tools=self.tools,
            verbose=self.verbose,
            max_iterations=self.settings.agent_max_iterations,
            handle_parsing_errors=True
        )

    def _build_agent(self):
        """Build the DevOps agent."""
        prompt = ChatPromptTemplate.from_messages([
            ("system", DEVOPS_SYSTEM_PROMPT),
            MessagesPlaceholder("chat_history", optional=True),
            ("human", "{input}"),
            MessagesPlaceholder("agent_scratchpad"),
        ])

        return create_tool_calling_agent(self.llm, self.tools, prompt)

    async def ainvoke(
        self,
        task: str,
        chat_history: List[tuple] = None
    ) -> Dict[str, Any]:
        """Async execute a DevOps task."""
        history = []
        if chat_history:
            for human, ai in chat_history:
                history.append(HumanMessage(content=human))
                history.append(AIMessage(content=ai))

        result = await self.executor.ainvoke({
            "input": task,
            "chat_history": history
        })

        return {
            "output": result["output"],
            "intermediate_steps": [
                {
                    "tool": step[0].tool,
                    "input": step[0].tool_input,
                    "output": str(step[1])[:500]
                }
                for step in result.get("intermediate_steps", [])
            ]
        }

    def invoke(
        self,
        task: str,
        chat_history: List[tuple] = None
    ) -> Dict[str, Any]:
        """Sync execute a DevOps task."""
        history = []
        if chat_history:
            for human, ai in chat_history:
                history.append(HumanMessage(content=human))
                history.append(AIMessage(content=ai))

        result = self.executor.invoke({
            "input": task,
            "chat_history": history
        })

        return {
            "output": result["output"],
            "intermediate_steps": [
                {
                    "tool": step[0].tool,
                    "input": step[0].tool_input,
                    "output": str(step[1])[:500]
                }
                for step in result.get("intermediate_steps", [])
            ]
        }


def create_devops_agent(
    model_config: str = "general",
    verbose: bool = False
) -> DevOpsAgent:
    """Factory function to create a DevOps agent."""
    config = MODEL_CONFIGS.get(model_config, MODEL_CONFIGS["general"])
    return DevOpsAgent(
        model_name=config["model"],
        temperature=config["temperature"],
        verbose=verbose
    )
