"""
NOC (Network Operations Center) Agent
Specialized agent for network troubleshooting and operations.
Adapted for LangChain 1.x using LCEL.
"""
from typing import Optional, List, Dict, Any
from langchain_ollama import ChatOllama
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables import RunnablePassthrough
from langchain_core.messages import HumanMessage, AIMessage

from config import get_settings, MODEL_CONFIGS
from tools import (
    PingTool,
    DNSLookupTool,
    PortScanTool,
    SSHCommandTool,
    FileReadTool,
    KnowledgeSearchTool,
)


NOC_SYSTEM_PROMPT = """You are an expert NOC (Network Operations Center) engineer with deep expertise in:

**Satellite Communications:**
- VSAT terminals: Intellian, Cobham, KVH, Sailor
- Antenna systems: Seatel, TracPhone
- Satellite protocols: DVB-S2, DVB-S2X
- Orbits: GEO, MEO, LEO (including Starlink)

**Enterprise Networking:**
- Cisco IOS/IOS-XE (routers, switches)
- Juniper Junos
- Palo Alto firewalls
- Fortinet FortiGate
- SD-WAN: Versa Networks, Cisco SD-WAN

**Troubleshooting Methodology:**
1. Gather information - check connectivity, logs, configurations
2. Isolate the problem - network layer, application, hardware
3. Identify root cause - analyze patterns, compare baselines
4. Implement fix - provide specific commands/steps
5. Verify resolution - confirm connectivity restored

When responding:
- Be specific with commands and outputs
- Reference vendor documentation when available
- Consider impact on live systems
- Provide verification steps

Always prioritize service restoration over root cause analysis in critical situations."""


class NOCAgent:
    """NOC Agent for network troubleshooting and operations using LCEL."""

    def __init__(
        self,
        model_name: Optional[str] = None,
        temperature: float = 0.2,
        verbose: bool = False
    ):
        self.settings = get_settings()
        self.model_name = model_name or self.settings.noc_expert_model
        self.temperature = temperature
        self.verbose = verbose

        self.llm = ChatOllama(
            base_url=self.settings.ollama_url,
            model=self.model_name,
            temperature=self.temperature
        )

        self.tools = [
            PingTool(),
            DNSLookupTool(),
            PortScanTool(),
            SSHCommandTool(),
            FileReadTool(),
            KnowledgeSearchTool(),
        ]

        self.chain = self._build_chain()

    def _build_chain(self):
        """Build the NOC agent chain using LCEL."""
        prompt = ChatPromptTemplate.from_messages([
            ("system", NOC_SYSTEM_PROMPT),
            MessagesPlaceholder("chat_history", optional=True),
            ("human", "{input}")
        ])

        return prompt | self.llm | StrOutputParser()

    def _format_tools_description(self) -> str:
        """Format available tools as a string for context."""
        tool_descriptions = []
        for tool in self.tools:
            tool_descriptions.append(f"- {tool.name}: {tool.description}")
        return "\n".join(tool_descriptions)

    async def ainvoke(
        self,
        task: str,
        chat_history: List[tuple] = None
    ) -> Dict[str, Any]:
        """Async execute a NOC task."""
        history = []
        if chat_history:
            for human, ai in chat_history:
                history.append(HumanMessage(content=human))
                history.append(AIMessage(content=ai))

        # Add tool context to the task
        enhanced_task = f"""{task}

Available tools for reference:
{self._format_tools_description()}

Provide your analysis following the NOC troubleshooting methodology."""

        result = await self.chain.ainvoke({
            "input": enhanced_task,
            "chat_history": history
        })

        return {
            "output": result,
            "intermediate_steps": []
        }

    def invoke(
        self,
        task: str,
        chat_history: List[tuple] = None
    ) -> Dict[str, Any]:
        """Sync execute a NOC task."""
        history = []
        if chat_history:
            for human, ai in chat_history:
                history.append(HumanMessage(content=human))
                history.append(AIMessage(content=ai))

        # Add tool context to the task
        enhanced_task = f"""{task}

Available tools for reference:
{self._format_tools_description()}

Provide your analysis following the NOC troubleshooting methodology."""

        result = self.chain.invoke({
            "input": enhanced_task,
            "chat_history": history
        })

        return {
            "output": result,
            "intermediate_steps": []
        }

    async def troubleshoot(self, issue: str) -> Dict[str, Any]:
        """Structured troubleshooting workflow."""
        troubleshoot_prompt = f"""Perform a systematic troubleshooting for the following issue:

{issue}

Follow this methodology:
1. First, search the knowledge base for relevant documentation
2. Check connectivity to affected systems
3. Review any available logs
4. Identify potential causes
5. Recommend specific actions

Provide a structured analysis with findings and recommendations."""

        result = await self.ainvoke(troubleshoot_prompt)
        return {
            "issue": issue,
            "analysis": result["output"],
            "steps_taken": result["intermediate_steps"]
        }

    def troubleshoot_sync(self, issue: str) -> Dict[str, Any]:
        """Sync structured troubleshooting workflow."""
        troubleshoot_prompt = f"""Perform a systematic troubleshooting for the following issue:

{issue}

Follow this methodology:
1. First, search the knowledge base for relevant documentation
2. Check connectivity to affected systems
3. Review any available logs
4. Identify potential causes
5. Recommend specific actions

Provide a structured analysis with findings and recommendations."""

        result = self.invoke(troubleshoot_prompt)
        return {
            "issue": issue,
            "analysis": result["output"],
            "steps_taken": result["intermediate_steps"]
        }


def create_noc_agent(
    model_config: str = "noc",
    verbose: bool = False
) -> NOCAgent:
    """Factory function to create a NOC agent."""
    config = MODEL_CONFIGS.get(model_config, MODEL_CONFIGS["noc"])
    return NOCAgent(
        model_name=config["model"],
        temperature=config["temperature"],
        verbose=verbose
    )
