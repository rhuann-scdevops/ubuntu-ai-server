"""
NOC (Network Operations Center) Agent
Specialized agent for network troubleshooting and operations.
"""
from typing import Optional, List, Dict, Any
from langchain_ollama import ChatOllama
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain.agents import AgentExecutor, create_tool_calling_agent
from langchain_core.messages import HumanMessage, AIMessage

from config import get_settings, MODEL_CONFIGS
from tools import (
    PingTool,
    DNSLookupTool,
    PortScanTool,
    SSHCommandTool,
    FileReadTool,
    KnowledgeSearchTool,
)


NOC_SYSTEM_PROMPT = """You are an expert NOC (Network Operations Center) engineer with deep expertise in:

**Satellite Communications:**
- VSAT terminals: Intellian, Cobham, KVH, Sailor
- Antenna systems: Seatel, TracPhone
- Satellite protocols: DVB-S2, DVB-S2X
- Orbits: GEO, MEO, LEO (including Starlink)

**Enterprise Networking:**
- Cisco IOS/IOS-XE (routers, switches)
- Juniper Junos
- Palo Alto firewalls
- Fortinet FortiGate
- SD-WAN: Versa Networks, Cisco SD-WAN

**Troubleshooting Methodology:**
1. Gather information - check connectivity, logs, configurations
2. Isolate the problem - network layer, application, hardware
3. Identify root cause - analyze patterns, compare baselines
4. Implement fix - provide specific commands/steps
5. Verify resolution - confirm connectivity restored

When responding:
- Be specific with commands and outputs
- Reference vendor documentation when available
- Consider impact on live systems
- Provide verification steps

Always prioritize service restoration over root cause analysis in critical situations."""


class NOCAgent:
    """NOC Agent for network troubleshooting and operations."""

    def __init__(
        self,
        model_name: Optional[str] = None,
        temperature: float = 0.2,
        verbose: bool = False
    ):
        self.settings = get_settings()
        self.model_name = model_name or self.settings.noc_expert_model
        self.temperature = temperature
        self.verbose = verbose

        self.llm = ChatOllama(
            base_url=self.settings.ollama_url,
            model=self.model_name,
            temperature=self.temperature
        )

        self.tools = [
            PingTool(),
            DNSLookupTool(),
            PortScanTool(),
            SSHCommandTool(),
            FileReadTool(),
            KnowledgeSearchTool(),
        ]

        self.agent = self._build_agent()
        self.executor = AgentExecutor(
            agent=self.agent,
            tools=self.tools,
            verbose=self.verbose,
            max_iterations=self.settings.agent_max_iterations,
            handle_parsing_errors=True
        )

    def _build_agent(self):
        """Build the NOC agent."""
        prompt = ChatPromptTemplate.from_messages([
            ("system", NOC_SYSTEM_PROMPT),
            MessagesPlaceholder("chat_history", optional=True),
            ("human", "{input}"),
            MessagesPlaceholder("agent_scratchpad"),
        ])

        return create_tool_calling_agent(self.llm, self.tools, prompt)

    async def ainvoke(
        self,
        task: str,
        chat_history: List[tuple] = None
    ) -> Dict[str, Any]:
        """Async execute a NOC task."""
        history = []
        if chat_history:
            for human, ai in chat_history:
                history.append(HumanMessage(content=human))
                history.append(AIMessage(content=ai))

        result = await self.executor.ainvoke({
            "input": task,
            "chat_history": history
        })

        return {
            "output": result["output"],
            "intermediate_steps": [
                {
                    "tool": step[0].tool,
                    "input": step[0].tool_input,
                    "output": str(step[1])[:500]
                }
                for step in result.get("intermediate_steps", [])
            ]
        }

    def invoke(
        self,
        task: str,
        chat_history: List[tuple] = None
    ) -> Dict[str, Any]:
        """Sync execute a NOC task."""
        history = []
        if chat_history:
            for human, ai in chat_history:
                history.append(HumanMessage(content=human))
                history.append(AIMessage(content=ai))

        result = self.executor.invoke({
            "input": task,
            "chat_history": history
        })

        return {
            "output": result["output"],
            "intermediate_steps": [
                {
                    "tool": step[0].tool,
                    "input": step[0].tool_input,
                    "output": str(step[1])[:500]
                }
                for step in result.get("intermediate_steps", [])
            ]
        }

    async def troubleshoot(self, issue: str) -> Dict[str, Any]:
        """Structured troubleshooting workflow."""
        troubleshoot_prompt = f"""Perform a systematic troubleshooting for the following issue:

{issue}

Follow this methodology:
1. First, search the knowledge base for relevant documentation
2. Check connectivity to affected systems
3. Review any available logs
4. Identify potential causes
5. Recommend specific actions

Provide a structured analysis with findings and recommendations."""

        result = await self.ainvoke(troubleshoot_prompt)
        return {
            "issue": issue,
            "analysis": result["output"],
            "steps_taken": result["intermediate_steps"]
        }


def create_noc_agent(
    model_config: str = "noc",
    verbose: bool = False
) -> NOCAgent:
    """Factory function to create a NOC agent."""
    config = MODEL_CONFIGS.get(model_config, MODEL_CONFIGS["noc"])
    return NOCAgent(
        model_name=config["model"],
        temperature=config["temperature"],
        verbose=verbose
    )
